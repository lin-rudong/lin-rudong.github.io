---
title: Java
date: 2018-10-18 19:29:56
tags: 
categories: Java
---

#类加载

## 类加载过程
1. 加载。类加载器加载。
1. 验证（链接）。检查字节码。
1. 准备（链接）。类变量分配内存并默认初始化。
1. 解析（链接）。解析符号链接，链接到方法区的引用上去。
1. 初始化。超类初始化、类初始化。

## 类加载器
1. 引导类加载器。C++语言实现，加载JVM自身需要的类。没有父类加载器。
1. 扩展类加载器。加载扩展库。父类加载器为null，表示引导类加载器。
1. 系统类加载器（AppClassLoader）。程序中默认的类加载器。父类加载器为ExtClassLoader。

## 双亲委派模式
1. 除了引导类加载器外的类加载器都要有自己的父类加载器。通过复合而非继承实现父子关系。
1. 当类加载器收到类加载请求，会先把请求委托给父加载器去执行，依次递归。如果父类加载器无法完成加载任务，子加载器才会尝试去加载。

## 双亲委派模式优势
1. Java类随着它的类加载器一起具备了一种带有优先级的层次关系，通过这种层次关系可以避免类的重复加载。
1. 安全方面，保证了Java的核心类不会被随意替换。另外java.lang包的类系统类加载器没有权限加载，所以不能自定义该包的类。

## Class对象唯一的条件
1. 类全限名相同。
1. 加载类的类加载器实例对象相同。

## 显示加载
1. Class.forName()。
2. this.getClass().getClassLoader().loadClass()。

## 自定义类加载器的优势
1. 可以加载特定路径下的类。
1. 在加载前添加额外操作。比如class文件通过网络加密传输时，需要解密后才能加载。
1. 实现热部署功能。

## 双亲委派模型的破坏者
1. 服务提供者接口SPI由Java核心库提供，是由引导类加载器加载的，当提供第三方实现的时候，SPI的类加载器即引导类加载器在双亲委派中无法委派系统类加载器。
1. 引导类加载器可以委派线程上下文类加载器ContextClassLoader加载。

# JVM框架

## JVM三个子系统
1. 类加载系统
1. 运行时数据区
1. 执行引擎

## 运行时数据区
1. PC寄存器。
1. 栈。
1. 本地方法栈。
1. 堆。
1. 方法区。

## 执行引擎
1. 解释器。
1. JIT编译器。
1. 垃圾收集器。

# 死锁
1. 多个线程循环等待被占用的资源导致的无限期僵持现象。

## 死锁的4个必要条件
1. 互斥条件。资源只能独占不能共享。
1. 不可抢占条件。资源未使用完毕，其他申请者不能强行夺取。
1. 占有且申请条件。进程至少已经占有一个资源，并且又申请新的资源。
1. 循环等待条件。存在一个进程等待序列。

## 死锁预防（静态策略）
1. 打破互斥条件。独占属性由资源自身决定，无实用价值。
1. 打破不可抢占条件。实现困难，会降低系统性能。
1. 打破占有且申请条件。实行资源预先分配策略，即进程在运行前一次性向系统申请所需要的全部资源，如果不满足则不分配任何资源。
    * 进程执行时是动态的，一般执行之前很难知道它所需要的全部资源。
    * 资源利用率低。
    * 降低了进程的并发性。
1. 打破循环等待条件。实行资源有序分配策略，使进程申请占用资源时不会形成环路。比前面的预先分配的资源利用率要高。
    * 对系统的所有资源合理编号也是件困难事。
    * 为了遵循按编号申请的次序，暂不使用的资源也需要提前申请，增加了进程对资源的占用时间。

## 死锁避免（动态策略）
1. 银行家算法。从当前状态出发，逐个检查能完成工作的客户，假定完成工作后归还全部贷款，再继续检查下一个客户，知道所有客户完成即找到一个安全序列。
    * 寻找安全序列增加了系统开销。
    * 算法只能保证所有客户的需求，不能保证实时客户的快速响应。
    * 算法要求客户数保持固定不变。

## 死锁检测与恢复
1. 死锁预防避免比较困难，开销比较大。一般采用检查和恢复措施。
1. 死锁检测通过资源和进程的分配表以及等待表，判断是否由环路。
1. 死锁恢复一般的办法是撤销环路中代价最小的进程。

# 堆栈
1. 栈存基本类型和引用类型变量，堆存对象。
1. 栈的栈帧随方法的调用而产生，随方法的结束而回收，堆由GC回收管理。
1. 栈是线程私有的，堆是共享的。

# Nginx
1. 性能上，占用的系统资源更少，能支持更多的并发连接，特别是静态小文件。
1. 功能上，不仅是一个网页服务器，还可以作为反向代理负载均衡及缓存服务器使用。负载均衡，通过负载均衡算法将报文请求均衡分配给多个提供相同服务的后台服务器。普通代理是内网用户通过设备访问外网，而反向代理是外网用户通过设备访问内网。
1. 配置上，简单、方便、灵活。

# 外排序
1. 当大于内存的数据需要排序时，将数据分成多个文件，对每个文件用内排序排序，然后从排好序的每个文件中取出前面的部分进行归并排序，结果存入新的文件，依次循环。