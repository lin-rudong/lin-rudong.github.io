---
title: 大型网站技术架构
date: 2018-10-26 20:35:40
tags: 
categories: Java
---

# 概述

## 大型网站架构演化

### 大型网站软件系统的特点
1. 高并发，大流量。
1. 高可用。不间断服务。
1. 海量数据。
1. 用户分布广泛，网络情况复杂。
1. 安全环境恶劣。
1. 需求快速变更，发布频繁。
1. 渐进式发展。

### 大型网站架构演化发展历程
1. 初始阶段的网络架构。应用程序、数据库、文件都在同一台应用服务器上。
1. 应用服务和数据服务分离。3台服务器，应用服务器、数据库服务器和文件服务器。
    * 应用服务器需要处理大量的业务逻辑，需要更快CPU资源。
    * 数据库服务器需要快速磁盘检索和数据缓存，需要更快硬盘和更大内存。
    * 文件服务器需要存储大量用户上传的文件，需要更大的硬盘。
1. 使用缓存改善网站性能。
    * 数据库压力太大导致访问延迟。
    * 80%的业务访问集中在20%的数据上。
    * 2种缓存，应用服务器上的本地缓存和分布式缓存服务器的远程缓存。本地缓存速度更快一些，但受内存限制。远程分布式缓存可以使用集群的方式，部署大内存的服务器作为专门的缓存服务器。
1. 使用应用服务器集群改善网站的并发处理能力。
     * 使用集群是网站解决高并发、海量数据问题的常用手段。
     * 通过负载均衡调用服务器，可将访问请求分发到应用服务器集群。
1. 数据库读写分离。
    * 使用缓存后仍然有一部分读操作和全部写操作需要访问数据库，这个阶段数据库成为了瓶颈。
    * 数据库大多都提供主从热备功能，通过配置2台数据库主从关系，可以将一台数据库的数据更新同步到另一台服务器上。网站利用这一功能实现数据库读写分离，主数据库负责写操作，从数据库负责读操作，主数据库会将数据复制到从数据库。
    * 为了数据库读写分离对应用透明，通常在应用服务器端使用专门的数据访问模块。
1. 使用反向代理和CDN加速网站响应。
    * 不同地区的用户访问网站时，速度差别大，导致有的地方访问延迟高。
    * CDN（内容分发网络）和反向代理的基本原理都是缓存，区别在于CDN部署在网络提供商的机房，使用户可以从最近的网络提供商机房获取数据；反向代理则部署在网站的中心机房，当用户请求到达中心机房后，首先访问的是反向代理服务器，如果反向代理服务器中缓存着用户请求的资源，就直接返回给用户。
    * 加快用户访问速度，减轻后端服务器的负载压力。
1. 使用分布式文件系统和分布式数据库系统。
    * 数据库拆分手段是业务分库。
1. 使用NoSQL和搜索引擎。
    * 数据存储和检索需要越来越复杂，采用非关系数据库技术如NoSQL服务器和非关系数据库查询技术如搜索引擎服务器。
    * 应用服务器通过一个统一的数据访问模块来访问，分布式缓存服务器、分布式文件服务器、分布式数据库服务器、搜索引擎服务器和NoSQL服务器。
1. 业务拆分。
    * 不同业务应用服务器通过消息队列服务器进行数据分发。
1. 分布式服务。
    * 随着业务拆分越来越小，存储系统越来越庞大，部署维护越来越难，导致数据库连接资源不足。
    * 每一个应用系统都需要执行很多相同的业务操作，比如用户管理、商品管理等，可以将这些共用的业务提取出来，独立部署。由这些可复用的业务连接数据库，提供共用业务服务，而应用系统只需要管理用户界面，通过分布式服务器调用共用服务完成具体业务操作。

![](/images/大型网站架构.png)

### 大型网站架构演化的价值观
1. 大型网站架构技术的核心价值是随网站所需灵活应对。大型网站不是从无到有，而是能够随小型网站业务逐步发展，润物细无声。
1. 驱动大型网站技术发展的主要力量是网站的业务发展。

### 网站架构设计误区
1. 一味追随大公司的解决方案。
1. 为了技术而技术。
1. 企图用技术解决所有问题。

### 小结
1. 许多小型网站已经慢慢不需要再经历大型网站经历过的架构演化之路就可以逐步发展壮大，因为可以搭建在大型网站提供的云计算服务基础之上，所需要的一切技术资源：网络、计算、存储都可以按需购买。

## 大型网站架构模式
1. 模式描述了一个不断重复的问题机该问题解决方案的核心，让你可以一直使用该方案而不必做重复工作。

### 网站架构模式
1. 分层。
    * 应用层。负责具体业务和视图展示，如网站首页及搜索输入和结果展示。
    * 服务层。为应用层提供服务支持，如用户管理服务，购物车服务等。
    * 数据层。提供数据存储访问服务，如数据库、缓存、文件、搜索引擎等。
    * 在开发中，严格遵循分层架构的约束，禁止跨层次的调用，比如应用层直接调用数据层，及逆向调用，比如数据层调用服务层。
    * 应用层还可以再细分为视图层（美工负责）和业务逻辑层（工程师负责）；服务层也可以再细分为逻辑处理层和数据接口层。
1. 分割。
    * 在比如在应用层，将不同业务进行分割，例如将购物、论坛、搜索、广告分割成不同的应用。如果规模庞大业务复杂，购物业务还可以进一步分割成机票酒店业务、3C业务、小商品业务等。
1. 分布式。
    * 分布式意味着服务调用必须通过网络，这可能会对性能造成比较严重的影响。
    * 服务器越多，服务器宕机的概率也就越大，一台服务器宕机可能造成很多应用不能访问，可用性降低。
    * 数据在分布式的环境中需要保持数据一致性。
    * 分布式导致网站依赖错综复杂，开发管理维护困难。
1. 集群。
    * 对于用户访问集中的模块，比如首页，还需要将分布式独立部署的服务器集群化，即多台服务器部署相同应用构成一个集群，通过负载均衡设备共同对外提供服务。
    * 一个应用由多态服务器提供，当某台服务器发生故障时，负载均衡设备会将请求转发到集群中其他服务器上，使服务器故障不影响用户使用，提供系统的可用性。
1. 缓存。
    * 缓存就是将数据存放在距离计算最近的位置以加快处理速度。
    * 使用缓存的2个前提条件：一是数据访问热点不均衡，某些数据会被更频繁的访问，这些数据应该放在缓存中。二是数据在某个时间内有效，不会很快过期，否则会失效脏读。
    * 缓存可以加快数据访问速度，可以减轻后端负载压力，这一点对网站数据库架构至关重要，网站数据库几乎都是按照有缓存的前提进行负载能力设计的。
1. 异步。
    * 单一服务器内部可通过多线程共享内存队列的方法实现异步，在分布式系统中，多个服务器集群通过分布式消息队列实现异步，分布式消息队列可以看作内存队列的分布式部署。
    * 异步架构是典型的生产者消费者模式，2者不存在直接调用。
 1. 冗余。
    * 为了保证可用性，就需要一定程度的服务器冗余运行，数据冗余备份。
    * 访问和负载很小的服务也必须部署至少2台服务器构成一个集群，通过冗余提高服务高可用。数据库除了定期备份，存档保存，实现冷备份外，为了保证在线业务高可用，还需要对数据库进行主从分离，实时同步实现热备份。
    * 为了防止不可抗力，大型网站会在全球范围内部署灾备数据中心。
1. 自动化。
    * 自动化架构设计主要集中在发布运维方面。
    * 发布过程自动化可有效减少故障，发布过程包括，自动化代码管理，自动化测试，自动化安全检测，自动化部署。
    * 维护过程，自动化监控（对服务器进行心跳检测，监控关键数据指标），自动化报警，自动化失效转移（失效隔离），自动化失效回复，自动化降级（当超出网站最大处理能力时，拒绝部分请求关闭不重要的服务），自动化分配资源。
1. 安全。
    * 密码，手机校验码进行身份认证。
    * 登录、交易等重要操作对网络通信进行加密，敏感数据也进行加密处理。
    * 防止机器人攻击，使用验证码。
    * 对常见的XSS攻击、SQL注入，进行编码转换等响应处理。
    * 对于垃圾信息、敏感信息进行过滤。
    * 对交易转账等重要操作进行风险控制。

**分布式方案**
1. 分布式应用和服务：将分层和分割后的应用和服务模块分布式部署。提高网站性能和并发行，加快开发和发布速度，还可以复用共同的服务，便于业务功能扩展。
1. 分布式静态资源：网站的静态资源如JS、CSS，图片等资源独立分布式部署，并采用独立的域名，动静分离。可以减轻应用服务器的负载压力，独立域名加快浏览器并发加载的速度。
1. 分布式数据和存储：除了传统的关系数据库进行分布式部署外，为网站应用而生的NoSQL几乎都是分布式的。
1. 分布式计算：严格老说，应用、服务和数据都是计算，网站除了要处理这些在线业务外，还有一部分用户没有直观感受的后台业务处理，包括搜索引擎的索引构建、数据仓库的数据分析统计等。这些业务的计算规模非常庞大，目前普遍使用Hadoop以及MapReduce分布式计算框架进行此类批处理计算，其特点是移动计算而不是移动数据，将计算程序分发到数据所在的位置以加速计算和分布式计算。
1. 此外，还有分布式配置、分布式锁和分布式文件。  

**缓存设计**
1. CDN：内容分发网络，部署在距离终端用户最近的网络服务商，缓存静态资源热点内容。
1. 反向代理：网站前端架构的一部分，缓存静态资源热点内容。
1. 本地缓存：在应用服务器本地缓存着热点数据，可以直接访问无需访问数据库。
1. 分布式缓存：远程分布式缓存集群。

**异步消息队列的特性**
1. 提高系统可用性。消费者服务器故障，数据可以在消息队列服务器中存储，生产者继续处理业务请求，系统整体表现无故障。
1. 加快网站响应速度。生产者不用等待消费者处理就可以返回。
1. 消除并发访问高峰。消息队列可以存储突然增加的访问请求数据，等待消费者服务器处理。

### 架构模式在新浪微博的应用
1. 异步推拉结合的模式。用户发表微博后系统将微博写入消息队列后立即返回，用户响应迅速，消息队列消费者任务将微博推送给所有当前在线粉丝的订阅列表中，非在线用户登录后再根据关注列表拉取微博订阅列表。
1. 多级缓存策略。热门微博和明星用户的微博缓存在所有的微博服务器上，在线用户的微博和近期微博缓存在分布式缓存集群中，对于微博操作中常见的刷操作，几乎全部都是缓存访问操作。
1. 多个数据中心。为了提高系统的可用性和性能，多个数据中心可以让用户就近访问最近的数据中心，改善系统性能，同时也是数据冗余复制的灾备中心，所有的数据通过远程消息系统在不同的数据中心之间同步，提高系统可用性。

## 大型网站核心架构要素

### 性能
1. 浏览器端，通过浏览器缓存、使用页面压缩、合理布局页面、减少Cookie传输改善性能。
1. CDN，将网站静态内容分发至离用户最近的网络服务商机房，使用户通过最短访问路径获取数据。可以在网站机房部署反向代理服务器，缓存热点文件，加快请求响应速度，减轻应用服务器负载压力。
1. 在应用服务器端，可以使用服务器本地缓存和分布式缓存，通过缓存在内存中的热点数据处理用户请求，加快请求处理过程，减轻数据库负载压力。
1. 可以通过异步操作将用户请求发送至消息队列等待后续任何处理，而当前请求直接返回响应给用户。
1. 在网站有很多用户高并发请求的情况下，可以将多台应用服务器组成一个而集群共同对外服务，提供整体处理能力，改善性能。
1. 在代码层面，也可以通过使用多线程、改善内存管理等手段优化性能。
1. 在数据库服务器端，索引、缓存、SQL优化等性能优化手段都已经比较成熟。而方兴未艾的NoSQL数据库通过优化数据模型、存储结构、伸缩特性等手段在性能方面的优势也日趋明显。

### 可用性
1. 网站高可用的主要手段是冗余。
1. 对于应用服务器而言，多台应用服务器通过负载均衡设备组成一个集群共同对外提供服务，任何一台服务器宕机，只需把请求切换到其他服务器，但是一个前提条件是应用服务器上不能保存请求的会话信息，否则会导致会话丢失，即使转发到其他服务器也无法完成业务。

### 伸缩性
1. 衡量架构伸缩性的主要标准就是是否可以用多台服务器构建集群，是否容易向集群中添加新的服务器。
1. 对于应用服务器集群，只要服务器上不保存数据，所有服务器都是对等的，通过使用合适的负载均衡设备就可以向集群中不断加入服务器。
1. 对于缓存服务器集群，加入新的服务器可能会导致缓存路由失效，需要改进缓存路由算法保证缓存数据的可访问性。
1. 关系数据库虽然支持数据复制，主从热等机制，但是很难做到大规模集群的可伸缩性，因此关系数据库的集群伸缩性方案必须在数据库之外实现，通过路由分区等手段将部署有多个数据库的服务器组成一个集群。
1. 至于大部分NoSQL数据库产品，由于其先天就是为海量数据而生，因此其对伸缩性的支持通常都非常好，可以做到在较少运维参与的情况下实现集群规模的线性伸缩。

### 扩展性
1. 衡量网站架构扩展性好坏的主要标准就是在网站增加新的业务产品时，是否可以实现对现有产品透明无影响，无需要任何改动或者很少改动既有业务功能就可以上线新产品。不同产品之间是否很少耦合。
1. 网站可扩展架构的主要手段是事件驱动架构和分布式服务。
1. 事件驱动架构在网站通常利用消息队列实现，将用户请求和其他业务事件构造成消息发送到消息队列，消费者从消息队列中获取消息进行处理。通过这种方式将消息产生和消息处理分离开来，可以透明地增加新消息生产者任务或者新的消息消费者任务。
1. 分布式服务则是将业务和可复用服务分离开来，通过分布式服务框架调用。新增产品可以通过调用可复用的服务实现自身的业务逻辑，而对现有产品没有任何影响。
1. 大型网站为了保持市场地位，还会吸引第三方开发者，调用网站服务。

### 安全性

# 架构

## 瞬时响应：网站的高性能架构

### 网站性能测试

**性能优化手段**
1. 前端架构优化手段，通过优化页面HTML样式、利用浏览器端的并发和异步特性、调整浏览器缓存策略、使用CDN服务、反向代理等手段，使浏览器尽快地显示用户感兴趣的内容、尽可能近地获取页面内容。
1. 后端架构优化手段，使用缓存加速数据读取、使用集群提高吞吐能力，使用异步消息加快请求响应及实现削峰，使用代码优化手段改善程序性能。
1. 基础设施优化手段，建设优化骨干网、使用高性价比定制服务器、利用虚拟机技术优化资源利用。

**性能测试指标**
1. 响应时间。
1. 并发数。
1. 吞吐量。HPS每秒HTTP请求数，QPS每秒查询数，TPS每秒事务数。吞吐量随着并发数增大，先是增加然后下降到系统崩溃0。
1. 性能计数器。包括System Load、对象与线程数、内存使用、CPU使用、磁盘与网络I/O等指标，也是系统监控的重要参数。
    * System Load系统负载，指当前正在被CPU执行和等待被CPU执行的进程数目总和，是反映系统忙闲程度的重要指标。理想情况是所有CPU都在使用，没有进程在等待处理，所有Load的理想值是CPU的数目。在Linux用top命令查看。

**性能测试方法**
1. 性能测试。目标性能。系统最佳运行点，响应时间较短。
1. 负载测试。最大负载点。
1. 压力测试。
1. 稳定性测试。

**性能优化策略**
1. 性能分析。分析影响性能的主要因素是磁盘、内存、CPU还是网络。
1. 性能优化。Web前端性能优化、应用服务器性能优化、存储服务器性能优化。

### Web前端性能优化
1. 主要优化手段有优化浏览器访问、使用反向代理、CND。

**浏览器访问优化**
1. 减少http请求。
    * 减少http的主要手段是合并CSS、合并JavaScrpt、合并图片。
1. 使用浏览器缓存。
    * 静态资源文件通过设置Cache-Control和Expires属性，设定浏览器缓存，缓存时间可以很长。
    * 如果静态资源文件变化，可以通过改变文件名实现，即更新文件为不是更新文件内容。
    * 更新静态资源的时候，应该一个文件一个文件逐步更新，并有一定的间隔，降低峰值。
1. 启用压缩。
    * 压缩可以减少通信传输的数据量，但会增加服务器和浏览器的压力，如果通信带宽良好，而服务器资源不足的情况要权衡考虑。
1. 减少Cookie传输。
    * Cookie包含在每次请求和响应中，应尽量减少Cookie中传输的数据量。
    * 对于某些静态资源的访问，如CSS、JavaScript等，发送Cookie是没有意义的，可以考虑静态资源使用独立域名访问，避免请求静态资源时发送Cookie。
1. CSS放在页面最上面、JavaScript放在页面最下面。
    * 浏览器会再下载完全部CSS之后才对整个页面进行渲染，因此最好的做法是将CSS放在页面最上面。JavaScript执行可能会阻塞页面，所以一般JavaScript放在页面最下面，除非页面解析时需要用到JavaScript。

**CDN加速**
1. 本质是一个缓存，做到网络访问第一跳就能获取数据。缓存静态资源，如图片、文件、CSS、JavaScript、静态网页。

**反向代理**
1. 传统代理服务器位于浏览器一侧，代理浏览器将HTTP请求发送到互联网上，而反向代理服务器位于网站机房一侧，代理网站Web服务器接收HTTP请求。
1. 和传统代理服务器可以保护浏览器一样，反向代理服务器也具有保护网站安全的作用。
1. 可以将静态内容缓存在反向代理服务器上，也可以把热点动态内容也缓存在代理服务器上，如果动态内容有变化，通过内部通知机制通知反向代理缓存失效，反向代理会加载最新的动态内容再次缓存起来。

### 应用服务器性能优化
1. 优化手段主要有缓存、集群、异步。

**分布式缓存**
1. 网站性能优化第一定律：优先考虑使用缓存优化性能。分布式体现在不同的缓存服务器缓存的范围数据不同，而集群体现在功能的延申性，多台缓存服务器共同提供缓存功能，且可以通过增加服务器到集群扩容。
1. 缓存的基本原理，将数据存储在相对较高访问速度的存储介质中。一方面缓存可以减少数据访问的时间，另一方面缓存可以避免重复计算。
    * 缓存的本质是一个内存Hash表，数据缓存以一对Key、Value的形式存储在内存Hash表中，Hash表数据读写的时间复杂度是O(1)。
    * 缓存主要用来存放读写比很高，很少变化的数据。根据二八定律，80%的访问落在20%的数据上，所以缓存热点数据可以很好地改善系统性能。
1. 合理使用缓存。
    * 频换修改的数据不适合缓存。没有热点访问也不适合缓存。
    * 一般会对缓存的数据设置失效时间，一旦超过失效时间就要从数据库中重新加载，因此应用要容忍一定时间的数据不一致。还有一种策略是数据更新时立即更新缓存，这会带来更多的系统开销和事务一致性问题。
    * 缓存可用性。有的网站通过缓存热备来提高缓存可用性，但这有违缓存的初衷，缓存不应该被当做一个可靠的数据源来使用。通过分布式缓存服务器集群，将缓存数据分布到集群多台服务器可在一定程度上改善缓存的可用性，当一台缓存服务器宕机的时候，只有部分缓存数据丢失，重新加载这部分数据不会对数据库产生很大影响。
    * 缓存预热。缓存中存放的是热点数据，热点数据又是缓存系统利用LRU（最近最少使用）对不断访问的数据筛选淘汰，这个过程需要花费较长的时间。新启动的缓存系统没有数据，最好在缓存系统启动时就把热点数据加载好。
    * 缓存穿透。如果因为不恰当的业务、或者恶意攻击持续高并发地请求某个不存在的数据，由于缓存没有保存该数据，所有的请求都会落到数据库上。一个简单的对策是将不存在的数据也缓存起来，value值为null。
1. 分布式缓存架构。
    * JBoss Cache为代表的需要更新同步的分布式缓存。JBoss Cache分布式缓存在集群中所有服务器中保存相同的缓存数据，当集群中的某台服务器有缓存数据更新的时候，会通知集群中其他机器更新缓存数据。通常会将应用程序和缓存部署在同一台服务器上，这样会受限于内存，而且同步带来的代价也很大。因而这种方案更多见于企业应用系统中，大型网站很少使用。
    * Memcached为代表的不互相通信的分布式缓存。缓存与应用分离部署，应用程序通过一致性Hash等路由算法选择缓存服务器远程访问缓存数据。
1. Memcached。
    * 简单的通信协议，需要考虑通信协议和通信序列化协议。Memcached使用TCP协议通信（UDP也支持），序列化协议则是基于文本的自定义协议，以命令关键字开头，后面是一组命令操作数。
    * 丰富的客户端程序。Java、C/C++/C#、Python、PHP、Ruby、Perl等主流的网站编程语言都支持。
    * 高性能的网络通信。服务端通信模块基于Libevent，支持事件出发的网络通信程序库。
    * 高效的内存管理。内存管理中一个令人头痛的问题是内存碎片管理。Memcached使用固定空间分配，这会浪费空间，但是避免内存碎片管理提高了效率。
    * 互不通信的服务器集群架构。客户端路由算法一致性Hash是数据存储伸缩性架构设计的经典范式。正是集群内服务器互不通信使得集群可以做到几乎无限制的线性伸缩。很多NoSQL在数据持久化、支持复杂数据结构、性能上由于Memcached。

**异步操作**
1. 使用消息队列将调用异步化，可改善网站的扩展性，还可以改善网站系统的性能。
1. 消息队列可以削峰填谷，任何可以晚点做的事情都应该晚点再做。

**使用集群**
1. 使用负载均衡技术为一个应用构建一个由多台服务器组成的服务器集群，将分并访问请求分发到多台服务器上处理。

**代码优化**
1. 多线程。使用多线程的2个原因，IO阻塞和多CPU。
    * 启动线程数=任务执行时间/（任务执行时间-IO等待时间）*CPU内核数。
    * 线程安全的主要手段有：将对象设计为无状态对象，使用局部对象，并发访问资源时使用锁。
1. 资源复用。
    * 要尽量减少那些开销很大的系统资源的创建和销毁，比如数据库连接、线程、网络通信连接和复杂对象。
    * 资源复用的主要有2种模式，单例和对象池。数据库连接使用的连接池就属于对象池，多线程使用的线程池也属于对象池。
1. 数据结构。
1. 垃圾回收。
    * 当Eden区空间已满，就触发一次Young GC，将未失效的对象复制到From区；当Eden区空间再次用完，触发一次Yound GC，将Eden和From区的对象复制到To区；下一次则是将Eden和To区复制到From，依次类推。
    * 进入年老代的3种情况：长期存活的对象进入年老代（年龄大于阈值，或者如果Suivivor中相同年龄的对象总和大于Suivivor的一半，年龄>=该年龄的对象进入年老代）；大对象直接进入年老代；Minor GC后如果存活对象太多Survivor空间不够的话，超出的部分会进入年老代。
    * CMS GC：Minor GC发生前，判断是否安全，即年老代是否能容纳年轻代所有对象，如果安全则直接进行Minor GC；如果不安全的，且不允许担保失败，则改为Full GC；如果不安全且允许担保失败，尝试进行Minor GC，失败出现promotion failure则改为Full GC。如果在CMS GC并发标记和并发清除时，业务线程的执行导致进入年老代的对象没有空间容纳，出现concurrent mode failure，这时改用stop the world的Serial Old GC。
    * 发生Full GC（表示年老代stop the world）的5种情况：System.gc()调用；年老代空间不足，执行后仍不足OutOfMemoryError；永久代空间不足；MinorGC发生前，判断年老代是否能容纳历来晋升平均大小，不能改为Full GC；CMS GC。

### 存储性能优化
1. 机械硬盘和固态硬盘。
1. B+树和LSM树。
    * 由于磁盘访问时都是随机的，而机械硬盘在数据随机访问时性能较差，传统数据库使用B+树，在每次数据访问都需要多次访问磁盘影响性能。
    * NoSQL使用LSM树，